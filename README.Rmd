---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Projeto Final - R4DS2
### Aluno: Alan R. Panosso
### Data: 01/05/2021
<!-- badges: start -->
<!-- badges: end -->

# CO2 Virtual Science Data Environment

O objetivo desse material é apresentar os procedimentos básicos para aquisição de dados do satélite OCO-2 e processamento inicial em R.

## Aquisição de dados

**1)** Acesse o endereço <https://co2.jpl.nasa.gov/>
  
```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "600px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_01.png")
```
**2)** Acesse o Browse *OCO-2 Data* em *Level 2 Data Set OCO-2*.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "600px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_02.png")
```

**3)** Role a página para baixo e acesse *CUSTOMIZE PRODUCT ON BUILD PAGE*.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "600px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_03.png")
```

**4)** No menu à esquerda estarão as 9 categorias para personalizar o banco de dados.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "600px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_04.png")
```

**5)** Em *DATA TYPE* selecione **OCO-2 Satellite**.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "600px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_05.png")
```

**6)** Em *PRODUCTS* selecione **OCO-2 Full**.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "600px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_06.png")
```

**7)** Em *DATA VERSION* selecione **10**.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "600px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_07.png")
```

**8)** Em *SPATIAL + TEMPORAL* selecione **Customize Your Spatial + Temporal Coverage**.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "600px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_08.png")
```

**OPTION 01** Utilize para selecionar a área para aquisição dos dados.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "600px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_09.png")
```

**OPTION 02** Utilize para selecionar o período para aquisição dos dados.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "600px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_09_1.png")
```

**9)** Em *DOWN SAMPLE PRODUCT* selecione **Yes, I want a Level 3 data product**. Altere os valores das células e o passo temporal desejado.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "600px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_10.png")
```

**10)** Em *DATA VARIABLES* selecione as variáveis desejadas.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "600px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_11.png")
```


**11)** Abaixo são apresentadas as opções para os filtros e o tipo de arquivo, selecione **CSV FILE**.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "600px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_11_1.png")
```

**12)** Forneça um endereço de e-mail para onde os links serão direcionados.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "600px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_12.png")
```
**13)** Acesse o seu e-mail, será enviado uma mensagem com o endereço dos arquivos onde você poderá acompanhar o progresso do processamento de seus dados. Ao final dessa etapa um novo e-mail é enviado informando que os dados estão disponíveis.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "600px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_13.png")
```

**14)** Acesse o link enviado em seu e-mail e você será direcionado a página.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "600px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_14.png")
```

**15)** Role a página para baixo e selecione a opção **WGET File List**.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "800px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_15.png")
```


**16)** Salve o arquivo `.txt` na pasta `data-raw`.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "400px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/jpl_16.png")
```

**17)** O arquivo contém os endereços de cada arquivo para download.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "500px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/caminhos.png")
```

## Download dos arquivos

O código abaixo será utilizado para fazer o download dos arquivos CSV com os dados do satélite OCO2. 

```{r}
# Definindo o Pipe
`%>%` <- magrittr::`%>%`

# Links de download gerados pela NASA
links <- list.files(path = "data-raw/",
             pattern = ".txt",
             full.names = TRUE) %>%
    read.table() %>%
    dplyr::pull(V1)

# Definindo os caminhos e nomes dos arquivos
n_split <- lengths(stringr::str_split(links[1],"/"))
files.csv <- stringr::str_split(links,"/",simplify = TRUE)[,n_split]
files.csv <- paste0("data-raw/csv/",files.csv)

# Download dos arquivos .csv
# purrr::map2(links,
#             files.csv,
#             .f=download.file,mode="wb")
```

Imagem dos arquivos baixados. Observe o tamnho dos arquivo individuais, ao redor de *162 MB*.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "700px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/dow_csv.png")
```

## Faxina dos dados

O volume de dados é alto, ao todo os arquivos somam *11 GB*, então para garantir a reprodutibilidade desse material, vamos realizar uma faxina prévia dos dados, retirando os valores perdidos (falhas do sensor) que foram registrados como **-999999.0**.

```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "700px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/dados_perdidos.png")
```

O código abaixo realiza a faxina inicial dos dados, após sua execussão o volume de dados diminuiu consideravelmente, ao todo *72 MB*, como apresentado na imagem subsequente.


```{r,eval=FALSE}
faxina_co2 <- function(arquivo, col, valor_perdido){
   da <- readr::read_csv(arquivo) %>%
     dplyr::filter({{col}} != valor_perdido)
   readr::write_csv(da,arquivo)
}

purrr::map(files.csv, faxina_co2,
           col=`xco2 (Moles Mole^{-1})`,
           valor_perdido= -999999)
```


```{r echo=FALSE, fig.cap="",fig.align='center',out.width = "700px"}
knitr::include_graphics("https://raw.githubusercontent.com/arpanosso/projetofinal_r4ds2/master/inst/dow_csv_posfaxina.png")
```

Agora vamos compilar todos os arquivos em um único que será salvo no diretório *data/oco2.rds*.

```{r,eval=FALSE}
oco2 <- purrr::map_dfr(files.csv, ~readr::read_csv(.x))
readr::write_rds(oco2,"data/oco2.rds")
```

## Análise inicial

```{r,eval=FALSE}
library(tidyverse)
```

